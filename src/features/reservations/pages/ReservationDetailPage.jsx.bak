/**
 * ReservationDetailPage – /app/reservations/:id
 *
 * Shows full reservation detail + inline edit form.
 * Top section: read-only summary + quick actions
 * Bottom section: edit form (toggled)
 */
import { useCallback, useEffect, useState } from "react";
import {
  Link,
  useNavigate,
  useParams,
  useSearchParams,
} from "react-router-dom";
import { useTranslation } from "react-i18next";
import {
  ArrowLeft,
  CalendarDays,
  CheckCircle,
  CreditCard,
  Edit2,
  Mail,
  Phone,
  User,
  X,
  Loader2,
} from "lucide-react";
import { reservationsService } from "../../../services/reservationsService";
import { resourcesService } from "../../../services/resourcesService";
import { useAuth } from "../../../hooks/useAuth";
import { getErrorMessage } from "../../../utils/errors";
import { useToast } from "../../../hooks/useToast";
import { useReservationForm } from "../hooks/useReservationForm";
import ReservationForm from "../components/ReservationForm";
import { ReservationStatusBadge } from "../components/ReservationStatusBadge";
import { formatScheduleLabel, formatMoney } from "../utils";
import { canWriteReservations } from "../rbac";
import SkeletonLoader from "../../../components/common/molecules/SkeletonLoader";

// ── Info row ─────────────────────────────────────────────────────────────────
const InfoRow = ({ icon: Icon, label, value }) =>
  value ? (
    <div className="flex items-start gap-3 py-2.5 border-b border-slate-100 dark:border-slate-800 last:border-0">
      <Icon size={15} className="mt-0.5 shrink-0 text-slate-400" />
      <div>
        <p className="text-xs text-slate-400">{label}</p>
        <p className="text-sm font-medium text-slate-900 dark:text-slate-100">
          {value}
        </p>
      </div>
    </div>
  ) : null;

// ── Page ─────────────────────────────────────────────────────────────────────
const ReservationDetailPage = () => {
  const { id } = useParams();
  const { t } = useTranslation();
  const { user } = useAuth();
  const { showToast } = useToast();
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();

  const [reservation, setReservation] = useState(null);
  const [resources, setResources] = useState([]);
  const [loading, setLoading] = useState(true);
  const [actionBusy, setActionBusy] = useState("");
  const [error, setError] = useState("");
  const [editMode, setEditMode] = useState(
    () => searchParams.get("edit") === "true",
  );

  const canWrite = canWriteReservations(user);

  const locale = user?.locale === "en" ? "en-US" : "es-MX";

  // ── Load reservation + resources ──────────────────────────────────────────
  const load = useCallback(async () => {
    if (!id) return;
    setLoading(true);
    setError("");
    try {
      const [res, resourcesRes] = await Promise.all([
        reservationsService.getById(id),
        resourcesService.listMine(user?.$id),
      ]);
      setReservation(res);
      setResources(resourcesRes.documents || []);
    } catch (err) {
      setError(getErrorMessage(err, "No se pudo cargar la reserva."));
    } finally {
      setLoading(false);
    }
  }, [id, user?.$id]);

  useEffect(() => {
    load();
  }, [load]);

  // ── Populate edit form when reservation loads / edit toggled ──────────────
  const {
    form,
    errors: formErrors,
    submitting,
    submitError,
    onChange,
    submitUpdate,
  } = useReservationForm(
    reservation
      ? {
          resourceId: reservation.resourceId || reservation.propertyId || "",
          scheduleType:
            reservation.bookingType === "time_slot"
              ? "time_slot"
              : "date_range",
          checkInDate: reservation.checkInDate || "",
          checkOutDate: reservation.checkOutDate || "",
          startDateTime: reservation.startDateTime || "",
          endDateTime: reservation.endDateTime || "",
          guestName: reservation.guestName || "",
          guestEmail: reservation.guestEmail || "",
          guestPhone: reservation.guestPhone || "",
          guestCount: String(reservation.guestCount ?? "1"),
          baseAmount:
            reservation.baseAmount != null
              ? String(reservation.baseAmount)
              : "",
          totalAmount:
            reservation.totalAmount != null
              ? String(reservation.totalAmount)
              : "",
          currency: reservation.currency || "MXN",
          externalRef: reservation.externalRef || "",
          specialRequests: reservation.specialRequests || "",
          status: reservation.status || "pending",
          paymentStatus: reservation.paymentStatus || "pending",
        }
      : {},
  );

  // ── Quick actions ─────────────────────────────────────────────────────────
  const quickAction = async (label, patch) => {
    setActionBusy(label);
    setError("");
    try {
      await reservationsService.updateStatus(id, patch);
      showToast({ type: "success", message: "Reserva actualizada." });
      await load();
    } catch (err) {
      const msg = getErrorMessage(err, "No se pudo actualizar la reserva.");
      setError(msg);
      showToast({ type: "error", message: msg });
    } finally {
      setActionBusy("");
    }
  };

  const handleEditSubmit = async (e) => {
    await submitUpdate(e, id);
    if (!submitError) {
      setEditMode(false);
      await load();
    }
  };

  // ── Loading / error ───────────────────────────────────────────────────────
  if (loading) return <SkeletonLoader variant="detail" className="py-4" />;

  if (error && !reservation) {
    return (
      <section className="mx-auto max-w-2xl space-y-4">
        <Link
          to="/app/reservations"
          className="inline-flex items-center gap-1.5 text-sm text-slate-500 hover:text-slate-900 dark:hover:text-slate-100"
        >
          <ArrowLeft size={14} /> Volver
        </Link>
        <p
          role="alert"
          className="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/50 dark:bg-red-950/40 dark:text-red-300"
        >
          {error}
        </p>
      </section>
    );
  }

  const resourceTitle =
    resources.find(
      (r) => r.$id === (reservation.resourceId || reservation.propertyId),
    )?.title ||
    reservation.resourceId ||
    "—";

  return (
    <section className="mx-auto max-w-2xl space-y-5 pb-24">
      {/* ── Back + header ─────────────────────────────────────────────── */}
      <header className="space-y-1">
        <Link
          to="/app/reservations"
          className="inline-flex items-center gap-1.5 text-sm text-slate-500 transition hover:text-slate-900 dark:hover:text-slate-100"
        >
          <ArrowLeft size={14} /> Volver a reservas
        </Link>
        <div className="flex flex-wrap items-start justify-between gap-3">
          <div>
            <h1 className="text-xl font-semibold text-slate-900 dark:text-slate-100">
              {resourceTitle}
            </h1>
            <p className="text-xs text-slate-400">#{reservation.$id}</p>
          </div>
          <div className="flex flex-wrap gap-2">
            <ReservationStatusBadge
              status={reservation.status}
              type="reservation"
            />
            <ReservationStatusBadge
              status={reservation.paymentStatus}
              type="payment"
            />
          </div>
        </div>
      </header>

      {/* ── Error banner ──────────────────────────────────────────────── */}
      {error ? (
        <p
          role="alert"
          className="rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/50 dark:bg-red-950/40 dark:text-red-300"
        >
          {error}
        </p>
      ) : null}

      {/* ── Summary card ──────────────────────────────────────────────── */}
      {!editMode && (
        <div className="rounded-2xl border border-slate-200 bg-white p-5 dark:border-slate-700 dark:bg-slate-900">
          <InfoRow icon={User} label="Huésped" value={reservation.guestName} />
          <InfoRow icon={Mail} label="Email" value={reservation.guestEmail} />
          <InfoRow
            icon={Phone}
            label="Teléfono"
            value={reservation.guestPhone}
          />
          <InfoRow
            icon={CalendarDays}
            label="Fechas"
            value={formatScheduleLabel(reservation, locale)}
          />
          <InfoRow
            icon={CreditCard}
            label="Total"
            value={formatMoney(
              reservation.totalAmount,
              reservation.currency || "MXN",
              locale,
            )}
          />
          {reservation.externalRef && (
            <InfoRow
              icon={CreditCard}
              label="Ref. externa"
              value={reservation.externalRef}
            />
          )}
          {reservation.specialRequests && (
            <InfoRow
              icon={Edit2}
              label="Notas"
              value={reservation.specialRequests}
            />
          )}

          {/* ── Quick actions ────────────────────────────────────────── */}
          {canWrite && (
            <div className="mt-4 flex flex-wrap gap-2 border-t border-slate-100 pt-4 dark:border-slate-800">
              <button
                type="button"
                disabled={!!actionBusy}
                onClick={() => quickAction("confirm", { status: "confirmed" })}
                className="flex min-h-10 items-center gap-1.5 rounded-lg border border-cyan-300 px-3 text-xs font-semibold text-cyan-700 transition hover:bg-cyan-50 disabled:opacity-60 dark:border-cyan-700 dark:text-cyan-300 dark:hover:bg-cyan-950/30"
              >
                {actionBusy === "confirm" && (
                  <Loader2 size={12} className="animate-spin" />
                )}
                <CheckCircle size={13} />{" "}
                {t("appReservationsPage.actions.markConfirmed")}
              </button>
              <button
                type="button"
                disabled={!!actionBusy}
                onClick={() =>
                  quickAction("complete", {
                    status: "completed",
                    paymentStatus: "paid",
                  })
                }
                className="flex min-h-10 items-center gap-1.5 rounded-lg border border-emerald-300 px-3 text-xs font-semibold text-emerald-700 transition hover:bg-emerald-50 disabled:opacity-60 dark:border-emerald-700 dark:text-emerald-300 dark:hover:bg-emerald-950/30"
              >
                {actionBusy === "complete" && (
                  <Loader2 size={12} className="animate-spin" />
                )}
                <CreditCard size={13} />{" "}
                {t("appReservationsPage.actions.markCompleted")}
              </button>
              <button
                type="button"
                disabled={!!actionBusy}
                onClick={() => quickAction("cancel", { status: "cancelled" })}
                className="flex min-h-10 items-center gap-1.5 rounded-lg border border-rose-300 px-3 text-xs font-semibold text-rose-700 transition hover:bg-rose-50 disabled:opacity-60 dark:border-rose-700 dark:text-rose-300 dark:hover:bg-rose-950/30"
              >
                {actionBusy === "cancel" && (
                  <Loader2 size={12} className="animate-spin" />
                )}
                <X size={13} /> {t("appReservationsPage.actions.cancel")}
              </button>
              <button
                type="button"
                onClick={() => setEditMode(true)}
                className="flex min-h-10 items-center gap-1.5 rounded-lg border border-slate-300 px-3 text-xs font-semibold text-slate-700 transition hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-800"
              >
                <Edit2 size={13} /> Editar
              </button>
            </div>
          )}
        </div>
      )}

      {/* ── Edit form ─────────────────────────────────────────────────── */}
      {editMode && (
        <div className="rounded-2xl border border-slate-200 bg-white p-5 dark:border-slate-700 dark:bg-slate-900">
          <div className="mb-5 flex items-center justify-between">
            <h2 className="text-base font-semibold text-slate-900 dark:text-slate-100">
              Editar reserva
            </h2>
            <button
              type="button"
              onClick={() => setEditMode(false)}
              aria-label="Cancelar edición"
              className="flex h-8 w-8 items-center justify-center rounded-full text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800"
            >
              <X size={16} />
            </button>
          </div>

          {submitError ? (
            <p
              role="alert"
              className="mb-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/50 dark:bg-red-950/40 dark:text-red-300"
            >
              {submitError}
            </p>
          ) : null}

          <ReservationForm
            form={form}
            errors={formErrors}
            resources={resources}
            loading={false}
            submitting={submitting}
            mode="edit"
            onChange={onChange}
            onSubmit={handleEditSubmit}
          />
        </div>
      )}
    </section>
  );
};

export default ReservationDetailPage;
