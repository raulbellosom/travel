/**
 * DateRangePicker – mobile-safe date range selector built on dayjs.
 *
 * Design rules:
 *  - NO hover-only interactions (all tap-friendly)
 *  - pointer:fine  → compact desktop popover
 *  - pointer:coarse → full-width bottom-sheet modal
 *  - Range selection: first tap sets start, second tap sets end
 *  - Shows two months for easier range selection
 */
import { useCallback, useEffect, useLayoutEffect, useRef, useState } from "react";
import dayjs from "dayjs";
import { AnimatePresence, motion } from "framer-motion";
import { CalendarDays, ChevronLeft, ChevronRight, X } from "lucide-react";

const DAYS = ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sá"];
const MONTHS = [
  "Enero",
  "Febrero",
  "Marzo",
  "Abril",
  "Mayo",
  "Junio",
  "Julio",
  "Agosto",
  "Septiembre",
  "Octubre",
  "Noviembre",
  "Diciembre",
];

/** Build a 6-week grid of day objects for a given month */
const buildMonthGrid = (year, month) => {
  const firstDay = dayjs(new Date(year, month, 1));
  const startOffset = firstDay.day(); // 0=Sunday
  const daysInMonth = firstDay.daysInMonth();
  const prevMonthDays = firstDay.subtract(1, "month").daysInMonth();
  const cells = [];

  // Before padding (prev month)
  for (let i = startOffset - 1; i >= 0; i--) {
    cells.push({
      day: prevMonthDays - i,
      thisMonth: false,
      date: firstDay.subtract(i + 1, "day"),
    });
  }
  // This month
  for (let d = 1; d <= daysInMonth; d++) {
    cells.push({
      day: d,
      thisMonth: true,
      date: dayjs(new Date(year, month, d)),
    });
  }
  // After padding (next month)
  const remaining = 42 - cells.length;
  for (let d = 1; d <= remaining; d++) {
    cells.push({
      day: d,
      thisMonth: false,
      date: firstDay.add(1, "month").date(d),
    });
  }
  return cells;
};

/** Single calendar month grid */
const MonthGrid = ({
  year,
  month,
  startDate,
  endDate,
  hoverDate,
  onDayClick,
  onDayHover,
  minDate,
  maxDate,
}) => {
  const cells = buildMonthGrid(year, month);

  return (
    <div className="min-w-70 select-none">
      <div className="mb-2 grid grid-cols-7 text-center text-[10px] font-semibold uppercase tracking-wide text-slate-400">
        {DAYS.map((d) => (
          <span key={d}>{d}</span>
        ))}
      </div>
      <div className="grid grid-cols-7 gap-y-0.5">
        {cells.map((cell, i) => {
          const iso = cell.date.format("YYYY-MM-DD");
          const isStart = startDate === iso;
          const isEnd = endDate === iso;
          const isInRange =
            startDate && endDate && iso > startDate && iso < endDate;
          const isHovered =
            startDate &&
            !endDate &&
            hoverDate &&
            iso > startDate &&
            iso <= hoverDate;
          const isToday = cell.date.isSame(dayjs(), "day");
          const isDisabled =
            !cell.thisMonth ||
            (minDate && iso < minDate) ||
            (maxDate && iso > maxDate);

          let bgClass = "";
          if (isStart || isEnd) {
            bgClass = "bg-cyan-600 text-white font-semibold";
          } else if (isInRange || isHovered) {
            bgClass =
              "bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-200";
          } else if (isToday) {
            bgClass = "ring-2 ring-cyan-400 ring-offset-1";
          }

          return (
            <button
              key={i}
              type="button"
              disabled={isDisabled}
              onClick={() => !isDisabled && onDayClick(iso)}
              onPointerEnter={() => !isDisabled && onDayHover?.(iso)}
              aria-label={cell.date.format("DD MMMM YYYY")}
              aria-pressed={isStart || isEnd}
              className={`flex h-9 w-full items-center justify-center rounded-lg text-sm transition
                ${isDisabled ? "cursor-not-allowed text-slate-300 dark:text-slate-600" : "cursor-pointer"}
                ${bgClass}
                ${
                  !isDisabled &&
                  !isStart &&
                  !isEnd &&
                  !isInRange &&
                  !isHovered &&
                  !isToday
                    ? "text-slate-700 dark:text-slate-200 [@media(hover:hover)]:hover:bg-slate-100 [@media(hover:hover)]:dark:hover:bg-slate-800"
                    : ""
                }
              `}
            >
              {cell.day}
            </button>
          );
        })}
      </div>
    </div>
  );
};

/**
 * DateRangePicker
 * @param {string}   startDate   - YYYY-MM-DD
 * @param {string}   endDate     - YYYY-MM-DD
 * @param {Function} onChange    - (start, end) => void
 * @param {string}   minDate     - YYYY-MM-DD
 * @param {string}   placeholder
 * @param {string}   className
 */
const DateRangePicker = ({
  startDate = "",
  endDate = "",
  onChange,
  minDate,
  maxDate,
  placeholder = "Seleccionar rango de fechas",
  className = "",
  disabled = false,
}) => {
  const [open, setOpen] = useState(false);
  const [hoverDate, setHoverDate] = useState(null);
  const [viewMonth, setViewMonth] = useState(() => {
    const base = startDate ? dayjs(startDate) : dayjs();
    return { year: base.year(), month: base.month() };
  });

  const containerRef = useRef(null);
  const panelRef = useRef(null);

  // Detect mobile (pointer:coarse / narrow viewport)
  const [isMobile, setIsMobile] = useState(
    () => typeof window !== "undefined" && window.matchMedia("(max-width: 767px)").matches,
  );
  const [flipRight, setFlipRight] = useState(false);
  const [flipUp, setFlipUp] = useState(false);

  // ── Selection logic ────────────────────────────────────────────────────────
  const handleDayClick = useCallback(
    (iso) => {
      if (!startDate || (startDate && endDate)) {
        // Start fresh
        onChange?.(iso, "");
      } else if (iso < startDate) {
        // Clicked before start → shift range
        onChange?.(iso, startDate);
        setOpen(false);
      } else {
        // Set end
        onChange?.(startDate, iso);
        setOpen(false);
      }
      setHoverDate(null);
    },
    [startDate, endDate, onChange],
  );

  // ── Navigation ─────────────────────────────────────────────────────────────
  const prevMonth = () =>
    setViewMonth(({ year, month }) => {
      if (month === 0) return { year: year - 1, month: 11 };
      return { year, month: month - 1 };
    });

  const nextMonth = () =>
    setViewMonth(({ year, month }) => {
      if (month === 11) return { year: year + 1, month: 0 };
      return { year, month: month + 1 };
    });

  const secondMonth = (() => {
    if (viewMonth.month === 11) return { year: viewMonth.year + 1, month: 0 };
    return { year: viewMonth.year, month: viewMonth.month + 1 };
  })();

  // ── Close on outside click ─────────────────────────────────────────────────
  useEffect(() => {
    if (!open) return;
    const handler = (e) => {
      if (containerRef.current && !containerRef.current.contains(e.target)) {
        setOpen(false);
      }
    };
    document.addEventListener("pointerdown", handler);
    return () => document.removeEventListener("pointerdown", handler);
  }, [open]);

  // ── Mobile detection ──────────────────────────────────────────────────────
  useEffect(() => {
    const mq = window.matchMedia("(max-width: 767px)");
    const handler = (e) => setIsMobile(e.matches);
    mq.addEventListener("change", handler);
    return () => mq.removeEventListener("change", handler);
  }, []);

  // ── Lock body scroll while mobile bottom-sheet is open ────────────────────
  useEffect(() => {
    if (!open || !isMobile) return;
    const prev = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    return () => {
      document.body.style.overflow = prev;
    };
  }, [open, isMobile]);

  // ── Smart positioning: flip if panel overflows viewport ──────────────────
  useLayoutEffect(() => {
    if (!open || isMobile || !panelRef.current) return;
    setFlipRight(false);
    setFlipUp(false);
    // rAF so the panel has painted with its natural position first
    const id = requestAnimationFrame(() => {
      if (!panelRef.current) return;
      const r = panelRef.current.getBoundingClientRect();
      setFlipRight(r.right > window.innerWidth - 8);
      setFlipUp(r.bottom > window.innerHeight - 8);
    });
    return () => cancelAnimationFrame(id);
  }, [open, isMobile]);

  // ── Display string ─────────────────────────────────────────────────────────
  const displayValue = (() => {
    if (startDate && endDate) {
      return `${dayjs(startDate).format("DD/MM/YYYY")} → ${dayjs(endDate).format("DD/MM/YYYY")}`;
    }
    if (startDate) return `${dayjs(startDate).format("DD/MM/YYYY")} → …`;
    return "";
  })();

  const clearRange = (e) => {
    e.stopPropagation();
    onChange?.("", "");
    setHoverDate(null);
  };

  return (
    <div ref={containerRef} className={`relative ${className}`}>
      {/* ── Trigger ── */}
      <button
        type="button"
        disabled={disabled}
        onClick={() => setOpen((v) => !v)}
        aria-label="Seleccionar rango de fechas"
        aria-expanded={open}
        aria-haspopup="dialog"
        className={`flex min-h-11 w-full items-center gap-2 rounded-lg border px-3 py-2 text-left text-sm transition
          ${disabled ? "cursor-not-allowed opacity-60" : "cursor-pointer"}
          ${
            open
              ? "border-cyan-500 ring-2 ring-cyan-500/20"
              : "border-slate-300 dark:border-slate-600"
          }
          bg-white dark:bg-slate-800
          text-slate-700 dark:text-slate-200`}
      >
        <CalendarDays size={16} className="shrink-0 text-slate-400" />
        <span className={`flex-1 ${!displayValue ? "text-slate-400" : ""}`}>
          {displayValue || placeholder}
        </span>
        {(startDate || endDate) && (
          <span
            role="button"
            tabIndex={0}
            onClick={clearRange}
            onKeyDown={(e) => e.key === "Enter" && clearRange(e)}
            aria-label="Limpiar fechas"
            className="flex h-5 w-5 items-center justify-center rounded-full text-slate-400 transition
              [@media(hover:hover)]:hover:bg-slate-200 [@media(hover:hover)]:hover:text-slate-700
              dark:[@media(hover:hover)]:hover:bg-slate-600"
          >
            <X size={12} />
          </span>
        )}
      </button>

      {/* ── Popover / Bottom sheet ── */}
      <AnimatePresence>
        {open && (
          <>
            {/* Backdrop (always visible on mobile for bottom sheet) */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="fixed inset-0 z-40 bg-black/40 md:hidden"
              onClick={() => setOpen(false)}
              aria-hidden="true"
            />

            {/* Calendar panel */}
            <motion.div
              ref={panelRef}
              role="dialog"
              aria-label="Seleccionar rango de fechas"
              aria-modal="true"
              // Mobile: slide up from bottom | Desktop: fade + scale down from trigger
              initial={isMobile ? { y: "100%" } : { opacity: 0, scale: 0.97, y: -6 }}
              animate={isMobile ? { y: 0 } : { opacity: 1, scale: 1, y: 0 }}
              exit={isMobile ? { y: "100%" } : { opacity: 0, scale: 0.97, y: -6 }}
              transition={{
                type: "spring",
                stiffness: isMobile ? 380 : 420,
                damping: isMobile ? 38 : 30,
                mass: 0.8,
              }}
              className={[
                // ── Mobile: full-width bottom-sheet ──────────────────────────
                "fixed bottom-0 left-0 right-0 z-50",
                "rounded-t-3xl border-t border-slate-200",
                "bg-white px-4 pb-safe pt-4 shadow-2xl",
                "dark:border-slate-700 dark:bg-slate-900",
                "max-h-[88svh] overflow-y-auto",
                // ── Desktop: absolute popover (overrides fixed) ──────────────
                "md:absolute md:bottom-auto md:top-[calc(100%+6px)]",
                "md:rounded-2xl md:border md:shadow-2xl",
                "md:max-h-none md:overflow-visible",
                // Horizontal flip: right-align when near right edge
                flipRight ? "md:right-0 md:left-auto" : "md:left-0 md:right-auto",
                // Vertical flip: open upward when near bottom edge
                flipUp ? "md:top-auto! md:bottom-[calc(100%+6px)]!" : "",
              ]
                .filter(Boolean)
                .join(" ")}
            >
              {/* Handle bar (mobile only) */}
              <div className="mb-4 flex justify-center md:hidden">
                <div className="h-1 w-10 rounded-full bg-slate-300 dark:bg-slate-600" />
              </div>

              <div className="mb-3 flex items-center justify-between">
                <button
                  type="button"
                  onClick={prevMonth}
                  aria-label="Mes anterior"
                  className="flex h-9 w-9 items-center justify-center rounded-lg border border-slate-200 text-slate-600 transition
                    [@media(hover:hover)]:hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300"
                >
                  <ChevronLeft size={18} />
                </button>
                <span className="text-sm font-semibold text-slate-900 dark:text-slate-100">
                  {MONTHS[viewMonth.month]} {viewMonth.year}
                  <span className="mx-3 text-slate-400">·</span>
                  {MONTHS[secondMonth.month]} {secondMonth.year}
                </span>
                <button
                  type="button"
                  onClick={nextMonth}
                  aria-label="Mes siguiente"
                  className="flex h-9 w-9 items-center justify-center rounded-lg border border-slate-200 text-slate-600 transition
                    [@media(hover:hover)]:hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300"
                >
                  <ChevronRight size={18} />
                </button>
              </div>

              {/* Month grids */}
              <div className="flex flex-col gap-6 md:flex-row">
                <MonthGrid
                  {...viewMonth}
                  startDate={startDate}
                  endDate={endDate}
                  hoverDate={hoverDate}
                  onDayClick={handleDayClick}
                  onDayHover={setHoverDate}
                  minDate={minDate}
                  maxDate={maxDate}
                />
                <MonthGrid
                  {...secondMonth}
                  startDate={startDate}
                  endDate={endDate}
                  hoverDate={hoverDate}
                  onDayClick={handleDayClick}
                  onDayHover={setHoverDate}
                  minDate={minDate}
                  maxDate={maxDate}
                />
              </div>

              {/* Footer hint */}
              <p className="mt-4 border-t border-slate-100 pt-3 text-center text-xs text-slate-400 dark:border-slate-800">
                {!startDate
                  ? "Toca para seleccionar fecha de entrada"
                  : !endDate
                    ? "Toca para seleccionar fecha de salida"
                    : `${dayjs(startDate).format("DD/MM/YYYY")} → ${dayjs(endDate).format("DD/MM/YYYY")}`}
              </p>

              {/* Close button (bottom sheet) */}
              <div className="mt-3 flex justify-end gap-2 md:hidden">
                <button
                  type="button"
                  onClick={() => {
                    onChange?.("", "");
                    setOpen(false);
                  }}
                  className="rounded-lg border border-slate-200 px-4 py-2.5 text-sm font-medium text-slate-600 dark:border-slate-700 dark:text-slate-300"
                >
                  Limpiar
                </button>
                <button
                  type="button"
                  onClick={() => setOpen(false)}
                  className="rounded-lg bg-cyan-600 px-4 py-2.5 text-sm font-medium text-white"
                >
                  Aplicar
                </button>
              </div>
            </motion.div>
          </>
        )}
      </AnimatePresence>
    </div>
  );
};

export default DateRangePicker;
